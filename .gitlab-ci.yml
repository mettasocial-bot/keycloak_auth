image: ruby:latest

before_script:
    - gem install dpl

stages:
    - development
    - production

development:
    variables:
      APP_NAME: "non-prod-meraklis-auth"
    type: deploy
    stage: development
    image: ruby:latest
    script:
        - dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY
    only:
        - master

alert_on_development_failure:
  stage: development
  script:
    - . ./ci-scripts/slack_alert.sh non-prod 0
  only:
    - master
  when: 
    on_failure

alert_on_development_success:
  script:
    - . ./ci-scripts/slack_alert.sh non-prod 1
  only:
    - master
  when: 
    on_success

production:
    variables:
      APP_NAME: "prod-meraklis-auth"
    type: deploy
    stage: development
    image: ruby:latest
    script:
        - dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY
    only:
        - /^production-.*$/

alert_on_production_failure:
  stage: production
  script:
    - . ./ci-scripts/slack_alert.sh production 0
  only:
    - /^production-.*$/
  when: 
    on_failure

alert_on_development_success:
  script:
    - . ./ci-scripts/slack_alert.sh production 1
  only:
    - /^production-.*$/
  when: 
    on_success