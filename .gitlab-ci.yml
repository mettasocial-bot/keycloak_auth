image: ruby:latest

before_script:
    - gem install dpl

stages:
    - deploy
    - alert

dry-run-keycloak:
    variables:
      APP_NAME: "non-prod-meraklis-auth"
    type: deploy
    stage: deploy
    image: ruby:latest
    script:
      - dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY
    only:
      refs:
        - master
      changes:
        - keycloak-custom-theme/**/*
        - docker-entrypoint.sh
        - Dockerfile
        - heroku.yml
        - .gitlab-ci.yml
        - ci-scripts/**/*

keycloak:
    variables:
      APP_NAME: "prod-meraklis-auth"
    type: deploy
    stage: deploy
    image: ruby:latest
    script:
        - dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY
    only:
      refs:
        - /^production-.*$/
      changes:
        - keycloak-custom-theme/**/*
        - docker-entrypoint.sh
        - Dockerfile
        - heroku.yml
        - .gitlab-ci.yml
        - ci-scripts/**/*

serverless:
  image: node:latest
  before_script:
    - . ./ci-scripts/do_npm_install.sh
  stage: deploy
  script:
      - npx serverless deploy
  only:
    refs:
      - /^production-.*$/
    changes:
      - serverless-functions/**/*
      - serverless.yml
      - .gitlab-ci.yml
      - ci-scripts/**/*

on failure:
  stage: alert
  before_script:
    - echo "Sending message on slack"
  script:
    - . ./ci-scripts/slack_alert.sh production 0
  only:
    refs: 
      - /^production-.*$/
    changes:
      - serverless-functions/**/*
      - serverless.yml
      - keycloak-custom-theme/**/*
      - docker-entrypoint.sh
      - Dockerfile
      - heroku.yml
      - .gitlab-ci.yml
      - ci-scripts/**/*
  when: 
    on_failure

on success:
  stage: alert
  before_script:
    - echo "Sending message on slack"
  script:
    - . ./ci-scripts/slack_alert.sh production 1
  only:
    refs:
      - /^production-.*$/
    changes:
      - serverless-functions/**/*
      - serverless.yml
      - keycloak-custom-theme/**/*
      - docker-entrypoint.sh
      - Dockerfile
      - heroku.yml
      - .gitlab-ci.yml
      - ci-scripts/**/*
  when: 
    on_success
